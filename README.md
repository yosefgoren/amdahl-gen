# About
[Amdahl-Gen](https://github.com/yosefgoren/amdahl-gen.git) is a framework for creating datasets which associate C/C++ source codes with their runtime performance.
Initially, it's aimed at collecting and aggregating the data required to estimate parallelizability of codes.



# Dependencies
* A working C/C++ SDK such as `gcc` or `clang`.
* The [`perf`](https://perf.wiki.kernel.org/index.php/Tutorial) analysis tool.
* `python3`, with the [`lark`](https://lark-parser.readthedocs.io/en/stable/) library



# Collection Framework
This framework for collecting results has 3 types of components: Configurations, Collectors, Results.


## Configurations
A configuration describes exactly what we want to collect, including all input parameters.
These configurations are provided in the form of `json` files, and more specifically - `json`
files that follow a schema which is specific to the available collection types.

For example, a configuration file for a collection of type 'alpha' will be a `json` file that follows the [alpha config schema](schemas/alpha.config.schema.json).


## Collectors
A collector is a program that receives a configuration of a certain type, and collects (generates, if required) appropriate results
that satisfy the requirements of the configuration.


## Results
Results are products of the framework, and can either be intermidiate - meaning they are used by some collectors, or they can be terminal - meaning they are only used outside the context of this framework. In either case, these results are `json` files generated by collectors and follow some result scheme.

For example, the result file of a collection of type 'alpha' will be a `json` file that follows the [alpha result schema](schemas/alpha.result.schema.json).



# Collection Types
## Sample
A collection of type 'sample' describes a single run of a program, in a specific setting.
This is an atomic collection type meaning it's results don't require any other collection results to be created.

### Configuration
[The configuration schema](schemas/sample.config.schema.json) requires providing a path to a target executable,
and the number of threads on which this sample should run.

### Collector
The collector follows these steps:
* `A.sample.config.json` -> `perf.data`: Use `perf record` to collect raw binary data.
* `perf.data` -> `anno.txt`: Use `perf annotate` to turn the binary data to textual.
* `anno.txt` -> `A.sample.result.json`: Use `parse_perfanno.py` to parse the textual data to the required output format.

### Result
[The result schema](schemas/sample.result.schema.json) requires the result will be a list of lines and their corresponding runtimes, and execution counts (the numebr of times the line was executed).


## Significant
A collection of type 'significant' describes an aggregation of samples - in the sense that multiple samples with the same setting are combined to create a result
which is more statistically significant - meaning it's not as effected by randomness or noise.

### Collector
The collector follows these steps:
* `A.significant.config.json` -> `A.sample.config.json`: Create a sample configuration based on the significant configuration.
* `A.sample.config.json` -> `[A.sample.result.json]`: Run the sample collector many times to get a set of results.
* `[A.sample.result.json]` -> `A.result.json`: Aggregate the sample results to a significant result.

### Result
Results of this collection correspond each source code line with the average time it took to run, this average is over both the many times the line was executed in each sample, and also over the many samples in which it was executed.
The results will follow the [significant results schema](schemas/significant.result.schema.json)


## Alpha
A collection of type 'alpha' describes a property of the executable for each lines in the source code.
This 'alpha' property is meant to describe the parallelizability of this line of the source code.
More speicifically 'alpha' is the 'proportion' of this line which is parallelizable.

### Configuration
[The configuration schema](schemas/alpha.config.schema.json) requires a list of thread counts which will be used to evaluate alpha,
and a repetition count which determines how many times each thread count sample to be taken for.

### Collector
The collector follows these steps:
* `A.alpha.config.json` -> `[A.significat.config.json]`: Create a set of collection configs of type 'significant', based on the provided configuration and with a variable number of threads.
* `[A.significat.config.json]` -> `[A.significant.result.json]`: Run the significant collector over each of the configurations to get a list of results.
* `[A.significant.result.json]` -> `A.alpha.result.json`: Aggregate the list of results by finding a best fit trendline and using it's parameter value as alpha.

### Result
Results associate each source line with an alpha value and follow the [alpha results schema](schemas/alpha.result.schema.json).